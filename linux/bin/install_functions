#!/bin/bash

EXIT_NOHOSTNAME=85
EXIT_NOIP=86
EXIT_NOENV=87
EXIT_NOUSER=88
EXIT_NODOMAIN=89
EXIT_NONETWORK=99

################################################################################
## Backup files that we are going to change
function backup_files {
        echo "Backing up files to ~/Archive"
        mkdir -p ~/Archive/etc/sysconfig/network-scripts ~/Archive/etc/udev/rules.d
        cp /etc/sysconfig/network ~/Archive/etc/sysconfig/network.`date +%Y%m%d-%H%M`
        cp /etc/sysconfig/network-scripts/ifcfg-eth0 ~/Archive/etc/sysconfig/network-scripts/ifcfg-eth0.`date +%Y%m%d-%H%M`
        mv /etc/udev/rules.d/70-persistent-net.rules ~/Archive/etc/udev/rules.d/70-persistent-net.rules.`date +%Y%m%d-%H%M`
}

################################################################################
## Set hostname, IP Address, subnet, and gateway
function setup_hostname {
        fqdn=$hostname".gpi.com"
        echo "Setting hostname to $hostname in /etc/sysconfig/network"
        sed -i "s/...-template../$hostname/" /etc/sysconfig/network
        hostname $hostname
}

################################################################################
## setup networking
function setup_network {
	backup_files
        if [ -z "$netmask" ]; then
                netmask="255.255.255.0"
                echo "No netmask provided.  Using default $netmask"
        fi
        echo "Setting ip to $ipaddress and netmask to $netmask in /etc/sysconfig/network-scripts/ifcfg-eth0"
        sed -i "s/10\.35\.5\.3./$ipaddress/" /etc/sysconfig/network-scripts/ifcfg-eth0
        sed -i "s/255.255.255.0/$netmask/" /etc/sysconfig/network-scripts/ifcfg-eth0

        if [ -z "$gw" ]; then
                gw=`echo $ipaddress | cut -f1-3 -d"."`".1"
                echo "No gateway given, using default of $gw"
        fi
        echo "Setting gateway to $gw in /etc/sysconfig/network"
        sed -i "s/10.35.5.1/$gw/" /etc/sysconfig/network

        echo "Adding $ipaddress $fqdn $hostname to /etc/hosts"
        echo "$ipaddress        $fqdn   $hostname" >> /etc/hosts

	echo "Regenerating persistent-net.rules file "
	echo add > /sys/class/net/eth0/uevent

	echo "Restarting network services"
	service network restart
	
	ping -q -c 5 $gw
	RES=$?
	chkconfig network on
	if [ $RES -ne 0 ];then
		return $EXIT_NONETWORK
	fi
		
}

################################################################################
## Make swap partition on /dev/sdb use full disk
function make_swap {
	echo "Resizing swap..."
	swapoff -a
	parted -s /dev/sdb rm 1
	parted -s /dev/sdb mklabel gpt
	parted -s -a optimal /dev/sdb mkpart primary linux-swap 0% 100%
	mkswap /dev/sdb1
	swapon -a
	swapon -s
}

################################################################################
## Set AD domain for pbis
function set_env_domain {
    if [ -z "$hostname" ]; then
        hostname = `hostname -s`
    fi
	if [ -z "$env" ]; then
		env=`echo $hostname | cut -f1 -d"-"`
	fi
	if [ $env == "dev" -o $env == "qa" ]; then
		shortdom="gpihst"
		domain="gpihst.hst"
		echo "This is a dev machine. Setting AD domain to $domain"
	elif [ $env == "prod" -o $env == "ral" ]; then
		shortdom="gpi"
		domain="gpi.com"
		echo "This is a non-dev machine. Setting AD domain to $domain"
		env="prod"
	else
		echo "Environment '$env' not supported"
		return $EXIT_NOENV
	fi
}

################################################################################
## Register with satellite server
function rhn_register {
	echo "Registering with the satellite server..."
	rhnreg_ks --activationkey=2-rhel-cq-${env}${db}  --force --profilename="`hostname -s`" --serverUrl=http://ral-satprd01.gpi.com/XMLRPC
}

################################################################################
## Join AD and setup base config
function join_ad {
	if [ -z "$user" ]; then
		return $EXIT_NOUSER
	fi

	echo "Joining AD domain..."
	/usr/bin/domainjoin-cli join $domain $user
	if [ $? -ne 0 ];then
		return $EXIT_NODOMAIN
	fi
	echo "Setting pbis configuration values"
	if [ $db ]; then
		/opt/pbis/bin/config RequireMembershipOf "$shortdom\\unix-sysadmin" "$shortdom\\unix-mysql-dba"
	else
		/opt/pbis/bin/config RequireMembershipOf "$shortdom\\unix-sysadmin"
	fi
	/opt/pbis/bin/config AssumeDefaultDomain "true"
	/opt/pbis/bin/config RemoteHomeDirTemplate ""
	/opt/pbis/bin/config HomeDirTemplate "%H/NAS/%U"
	/opt/pbis/bin/config LoginShellTemplate /bin/bash
	/opt/pbis/bin/config Local_LoginShellTemplate /bin/bash
	/opt/pbis/bin/config CreateHomeDir false
	echo "Fixing /etc/hosts..."
	sed -i "s/gpihst.hst/gpi.com/g" /etc/hosts
}

################################################################################
## Initialize Puppet
function init_puppet {
	echo "Initiallzing Puppet..."
	puppet agent -t 
	echo "Puppet initialized, goto https://ral-pupmstr01.gpi.com to continue"
}
